<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>AI Voice Chat Real-Time Test</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 40px auto; line-height: 1.6; }
        #chat-output { min-height: 100px; border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; white-space: pre-wrap; background: #f9f9f9; }
        .status { margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>üé§ AI Voice Chat (Real-Time TTS)</h1>
    <p>S·ª≠ d·ª•ng WebSockets ƒë·ªÉ stream vƒÉn b·∫£n v√† √¢m thanh c√πng l√∫c.</p>

    <textarea id="user-prompt" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." rows="3" style="width: 100%;"></textarea>
    <button onclick="startChat()" id="send-btn">G·ª≠i v√† Nghe</button>
    
    <div class="status" id="status-message">Tr·∫°ng th√°i: ƒê√£ s·∫µn s√†ng</div>

    <h2>Ph·∫£n h·ªìi c·ªßa AI:</h2>
    <div id="chat-output"></div>

    <script>
        // --- Web Audio API Setup ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let audioQueue = [];
        let isPlaying = false;
        let ws = null;

        // X·ª≠ l√Ω v√† ph√°t c√°c kh·ªëi √¢m thanh trong h√†ng ƒë·ª£i
        async function processQueue() {
            if (audioQueue.length === 0 || isPlaying) {
                return;
            }

            isPlaying = true;
            const audioData = audioQueue.shift();
            
            try {
                // Gi·∫£i m√£ d·ªØ li·ªáu √¢m thanh nh·ªã ph√¢n
                const audioBuffer = await audioCtx.decodeAudioData(audioData);
                const source = audioCtx.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioCtx.destination);
                source.start(0);

                // Ch·ªù cho ƒëo·∫°n √¢m thanh n√†y ph√°t xong tr∆∞·ªõc khi ph√°t ƒëo·∫°n ti·∫øp theo
                await new Promise(resolve => {
                    source.onended = () => {
                        isPlaying = false;
                        resolve();
                        // G·ªçi l·∫°i processQueue ƒë·ªÉ ph√°t kh·ªëi ti·∫øp theo ngay l·∫≠p t·ª©c
                        processQueue(); 
                    };
                });

            } catch (error) {
                console.error("Error decoding audio data:", error);
                isPlaying = false;
                processQueue(); // Th·ª≠ ph√°t kh·ªëi ti·∫øp theo
            }
        }

        // --- WebSocket Logic ---
        function startChat() {
            const prompt = document.getElementById('user-prompt').value;
            const outputDiv = document.getElementById('chat-output');
            const statusDiv = document.getElementById('status-message');
            const sendBtn = document.getElementById('send-btn');
            
            if (!prompt) return;

            // X√≥a n·ªôi dung c≈© v√† reset tr·∫°ng th√°i
            outputDiv.innerHTML = '';
            statusDiv.textContent = 'Tr·∫°ng th√°i: ƒêang k·∫øt n·ªëi...';
            sendBtn.disabled = true;
            audioQueue = [];
            isPlaying = false;
            
            // L·∫•y ƒë·ªãa ch·ªâ host hi·ªán t·∫°i
            const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
            const wsUrl = wsProtocol + window.location.host + "/ws/voice_chat";
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                statusDiv.textContent = 'Tr·∫°ng th√°i: ƒê√£ k·∫øt n·ªëi, ƒëang g·ª≠i prompt...';
                // G·ª≠i prompt t·ªõi backend
                ws.send("PROMPT:" + prompt);
            };

            ws.onmessage = async (event) => {
                if (typeof event.data === 'string') {
                    // Nh·∫≠n vƒÉn b·∫£n stream
                    const data = event.data;
                    if (data.startsWith('TEXT:')) {
                        const token = data.substring(5);
                        outputDiv.innerHTML += token;
                        statusDiv.textContent = 'Tr·∫°ng th√°i: Streaming VƒÉn b·∫£n...';
                    } else if (data.startsWith('ERROR:')) {
                        statusDiv.textContent = data;
                        sendBtn.disabled = false;
                    }
                } else if (event.data instanceof Blob) {
                    // Nh·∫≠n kh·ªëi √¢m thanh nh·ªã ph√¢n
                    statusDiv.textContent = 'Tr·∫°ng th√°i: Streaming √Çm thanh...';
                    const arrayBuffer = await event.data.arrayBuffer();
                    audioQueue.push(arrayBuffer);
                    if (!isPlaying) {
                        processQueue();
                    }
                }
            };

            ws.onclose = () => {
                statusDiv.textContent = 'Tr·∫°ng th√°i: K·∫øt th√∫c.';
                sendBtn.disabled = false;
            };

            ws.onerror = (error) => {
                console.error("WebSocket Error:", error);
                statusDiv.textContent = 'Tr·∫°ng th√°i: L·ªói k·∫øt n·ªëi WebSocket.';
                sendBtn.disabled = false;
            };
        }
    </script>
</body>
</html>